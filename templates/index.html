<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trader-Sim</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --border-color: #30363d;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --accent-green: #3fb950;
            --accent-red: #f85149;
            --accent-blue: #58a6ff;
            --accent-yellow: #d29922;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .data-source {
            font-size: 0.85rem;
            color: var(--text-secondary);
            padding: 4px 12px;
            background: var(--bg-tertiary);
            border-radius: 20px;
        }

        .data-source.live { color: var(--accent-green); }
        .data-source.sample { color: var(--accent-yellow); }

        .market-status {
            font-size: 0.85rem;
            padding: 4px 12px;
            background: var(--bg-tertiary);
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .market-status .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .market-status.open { color: var(--accent-green); }
        .market-status.open .dot { background: var(--accent-green); }
        .market-status.closed { color: var(--text-secondary); }
        .market-status.closed .dot { background: var(--text-secondary); }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
        }

        .card h2 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .metric:last-child { border-bottom: none; }

        .metric-label { color: var(--text-secondary); }
        .metric-value { font-weight: 600; font-family: 'SF Mono', Consolas, monospace; }

        .positive { color: var(--accent-green); }
        .negative { color: var(--accent-red); }

        .total-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .return-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .return-badge.positive { background: rgba(63, 185, 80, 0.15); }
        .return-badge.negative { background: rgba(248, 81, 73, 0.15); }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        th, td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            color: var(--text-secondary);
            font-weight: 500;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
        }

        td { font-family: 'SF Mono', Consolas, monospace; }

        tr:hover { background: var(--bg-tertiary); }

        .symbol {
            font-weight: 600;
            color: var(--accent-blue);
            cursor: pointer;
        }

        .symbol:hover { text-decoration: underline; }

        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 4px;
        }

        .tab {
            padding: 8px 16px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.9rem;
            border-radius: 6px 6px 0 0;
            transition: all 0.2s;
        }

        .tab:hover { color: var(--text-primary); background: var(--bg-tertiary); }
        .tab.active { color: var(--accent-blue); border-bottom: 2px solid var(--accent-blue); }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .trade-form {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr auto;
            gap: 12px;
            align-items: end;
        }

        .form-group { display: flex; flex-direction: column; gap: 4px; }
        .form-group label { font-size: 0.8rem; color: var(--text-secondary); }

        input, select {
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--accent-blue);
            color: white;
        }

        .btn-primary:hover { opacity: 0.9; }

        .btn-buy { background: var(--accent-green); color: white; }
        .btn-sell { background: var(--accent-red); color: white; }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); }

        .trade-result {
            margin-top: 16px;
            padding: 12px;
            border-radius: 6px;
            display: none;
        }

        .trade-result.success { background: rgba(63, 185, 80, 0.15); color: var(--accent-green); }
        .trade-result.error { background: rgba(248, 81, 73, 0.15); color: var(--accent-red); }

        .stock-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }

        .stock-card {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .stock-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }

        .stock-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .stock-symbol { font-size: 1.1rem; font-weight: 600; }
        .stock-price { font-size: 1.2rem; font-weight: 700; font-family: 'SF Mono', Consolas, monospace; }

        .stock-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            font-size: 0.8rem;
        }

        .stock-metric { text-align: center; }
        .stock-metric-label { color: var(--text-secondary); }
        .stock-metric-value { font-weight: 600; font-family: 'SF Mono', Consolas, monospace; }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            display: none;
        }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-close {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        @media (max-width: 768px) {
            .trade-form {
                grid-template-columns: 1fr 1fr;
            }
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Trader-Sim</h1>
            <div style="display: flex; gap: 12px; align-items: center;">
                <span class="market-status" id="marketStatus">
                    <span class="dot"></span>
                    <span id="marketStatusText">Checking...</span>
                </span>
                <span class="data-source" id="dataSource">Loading...</span>
            </div>
        </header>

        <div class="grid">
            <div class="card">
                <h2>Portfolio Value</h2>
                <div class="total-value" id="totalValue">$0.00</div>
                <span class="return-badge" id="returnBadge">+0.00%</span>
                <div style="margin-top: 16px">
                    <div class="metric">
                        <span class="metric-label">Day</span>
                        <span class="metric-value" id="currentDay">1 / 30</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Cash</span>
                        <span class="metric-value" id="cashValue">$0.00</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Holdings</span>
                        <span class="metric-value" id="holdingsValue">$0.00</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Positions</span>
                        <span class="metric-value" id="positions">0 / 10</span>
                    </div>
                </div>
            </div>

            <div class="card" style="grid-column: span 2;">
                <h2>Quick Trade</h2>
                <form class="trade-form" id="tradeForm">
                    <div class="form-group">
                        <label>Action</label>
                        <select id="tradeAction">
                            <option value="BUY">BUY</option>
                            <option value="SELL">SELL</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Symbol</label>
                        <input type="text" id="tradeSymbol" placeholder="e.g., NVDA" list="symbolList" required>
                        <datalist id="symbolList"></datalist>
                    </div>
                    <div class="form-group">
                        <label>Shares</label>
                        <input type="number" id="tradeShares" min="1" step="1" value="1" required>
                    </div>
                    <button type="submit" class="btn-buy" id="tradeBtn">BUY</button>
                </form>
                <div class="trade-result" id="tradeResult"></div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" data-tab="holdings">Holdings</button>
            <button class="tab" data-tab="history">History</button>
            <button class="tab" data-tab="chart">Chart</button>
            <button class="tab" data-tab="market">Market</button>
            <button class="tab" data-tab="screener">Screener</button>
        </div>

        <div class="tab-content active" id="holdings">
            <div class="card">
                <div id="holdingsTable">
                    <div class="loading">
                        <div class="spinner"></div>
                        Loading holdings...
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-content" id="history">
            <div class="card">
                <div id="historyTable">
                    <div class="loading">
                        <div class="spinner"></div>
                        Loading history...
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-content" id="chart">
            <div class="card">
                <h2>Portfolio Value Over Time</h2>
                <div id="chartContainer" style="position: relative; height: 400px;">
                    <canvas id="valueChart"></canvas>
                </div>
                <div id="chartEmpty" class="empty-state" style="display: none;">
                    <p>No value history yet.</p>
                    <p style="margin-top: 8px">Make some trades to start tracking your portfolio value over time.</p>
                </div>
            </div>
        </div>

        <div class="tab-content" id="market">
            <div class="card">
                <h2>Market Overview</h2>
                <div id="marketSummary">
                    <div class="loading">
                        <div class="spinner"></div>
                        Loading market data...
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-content" id="screener">
            <div class="card">
                <h2>Screened Opportunities</h2>
                <div id="screenerResults">
                    <div class="loading">
                        <div class="spinner"></div>
                        Screening stocks...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="quoteModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="quoteSymbol">STOCK</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="quoteContent"></div>
        </div>
    </div>

    <script>
        // State
        let stockUniverse = [];
        let portfolioStatus = null;

        // Format currency
        const formatCurrency = (val) => {
            return '$' + parseFloat(val).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        };

        // Format percent
        const formatPercent = (val) => {
            const sign = val >= 0 ? '+' : '';
            return sign + parseFloat(val).toFixed(2) + '%';
        };

        // Get color class
        const getColorClass = (val) => val >= 0 ? 'positive' : 'negative';

        // Check if market is open (NYSE/NASDAQ: 9:30 AM - 4:00 PM ET, Mon-Fri)
        function isMarketOpen() {
            const now = new Date();

            // Convert to Eastern Time
            const et = new Date(now.toLocaleString('en-US', { timeZone: 'America/New_York' }));
            const day = et.getDay();
            const hours = et.getHours();
            const minutes = et.getMinutes();
            const timeInMinutes = hours * 60 + minutes;

            // Market hours: 9:30 AM (570 min) to 4:00 PM (960 min)
            const marketOpen = 9 * 60 + 30;  // 9:30 AM
            const marketClose = 16 * 60;      // 4:00 PM

            // Check if weekday (1-5) and within market hours
            const isWeekday = day >= 1 && day <= 5;
            const isDuringHours = timeInMinutes >= marketOpen && timeInMinutes < marketClose;

            return isWeekday && isDuringHours;
        }

        // Update market status display
        function updateMarketStatus() {
            const statusEl = document.getElementById('marketStatus');
            const textEl = document.getElementById('marketStatusText');
            const open = isMarketOpen();

            statusEl.className = 'market-status ' + (open ? 'open' : 'closed');
            textEl.textContent = open ? 'Market Open' : 'Market Closed';
        }

        // Fetch portfolio status
        async function fetchStatus() {
            try {
                const res = await fetch('/api/status');
                const data = await res.json();
                portfolioStatus = data;
                updateStatusDisplay(data);
            } catch (err) {
                console.error('Failed to fetch status:', err);
            }
        }

        // Update status display
        function updateStatusDisplay(data) {
            document.getElementById('totalValue').textContent = formatCurrency(data.total_value);

            const returnBadge = document.getElementById('returnBadge');
            returnBadge.textContent = formatPercent(data.total_return);
            returnBadge.className = 'return-badge ' + getColorClass(data.total_return);

            document.getElementById('currentDay').textContent = `${data.day} / ${data.simulation_days}`;
            document.getElementById('cashValue').textContent = formatCurrency(data.cash);
            document.getElementById('holdingsValue').textContent = formatCurrency(data.holdings_value);
            document.getElementById('positions').textContent = `${data.num_holdings} / ${data.max_positions}`;

            const dataSource = document.getElementById('dataSource');
            dataSource.textContent = data.using_sample_data ? 'Sample Data' : 'Live Data';
            dataSource.className = 'data-source ' + (data.using_sample_data ? 'sample' : 'live');

            updateHoldingsTable(data.holdings);
        }

        // Update holdings table
        function updateHoldingsTable(holdings) {
            const container = document.getElementById('holdingsTable');

            if (!holdings || holdings.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>No holdings yet.</p>
                        <p style="margin-top: 8px">Use the Quick Trade form above to buy your first stock!</p>
                    </div>
                `;
                return;
            }

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th>Shares</th>
                            <th>Avg Price</th>
                            <th>Current</th>
                            <th>Value</th>
                            <th>P&L</th>
                            <th>P&L %</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            for (const h of holdings) {
                const colorClass = getColorClass(h.pnl);
                html += `
                    <tr>
                        <td><span class="symbol" onclick="showQuote('${h.symbol}')">${h.symbol}</span></td>
                        <td>${h.shares}</td>
                        <td>${formatCurrency(h.avg_price)}</td>
                        <td>${formatCurrency(h.current_price)}</td>
                        <td>${formatCurrency(h.current_value)}</td>
                        <td class="${colorClass}">${formatCurrency(h.pnl)}</td>
                        <td class="${colorClass}">${formatPercent(h.pnl_pct)}</td>
                        <td>
                            <button class="btn-sell" style="padding: 4px 12px; font-size: 0.8rem"
                                    onclick="quickSell('${h.symbol}', ${h.shares})">Sell All</button>
                        </td>
                    </tr>
                `;
            }

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Fetch and display history
        async function fetchHistory() {
            try {
                const res = await fetch('/api/history?limit=50');
                const data = await res.json();
                updateHistoryTable(data.transactions);
            } catch (err) {
                console.error('Failed to fetch history:', err);
            }
        }

        // Update history table
        function updateHistoryTable(transactions) {
            const container = document.getElementById('historyTable');

            if (!transactions || transactions.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No transactions yet.</p></div>';
                return;
            }

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Action</th>
                            <th>Symbol</th>
                            <th>Shares</th>
                            <th>Price</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            for (const t of transactions) {
                const actionClass = t.action === 'BUY' ? 'positive' : 'negative';
                const time = new Date(t.timestamp).toLocaleString();
                html += `
                    <tr>
                        <td style="color: var(--text-secondary)">${time}</td>
                        <td class="${actionClass}">${t.action}</td>
                        <td><span class="symbol" onclick="showQuote('${t.symbol}')">${t.symbol}</span></td>
                        <td>${t.shares}</td>
                        <td>${formatCurrency(t.price)}</td>
                        <td>${formatCurrency(t.total)}</td>
                    </tr>
                `;
            }

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Fetch and display market summary
        async function fetchMarket() {
            try {
                const res = await fetch('/api/market');
                const data = await res.json();
                updateMarketDisplay(data);
            } catch (err) {
                console.error('Failed to fetch market data:', err);
                document.getElementById('marketSummary').innerHTML = '<div class="empty-state"><p>Failed to load market data.</p></div>';
            }
        }

        // Update market display
        function updateMarketDisplay(data) {
            const container = document.getElementById('marketSummary');

            if (data.error) {
                container.innerHTML = `<div class="empty-state"><p>${data.error}</p></div>`;
                return;
            }

            let html = `
                <div class="grid" style="margin-bottom: 20px">
                    <div>
                        <div class="metric">
                            <span class="metric-label">Stocks Analyzed</span>
                            <span class="metric-value">${data.stocks_analyzed}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Avg Daily Change</span>
                            <span class="metric-value ${getColorClass(data.avg_daily_change)}">${formatPercent(data.avg_daily_change)}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Avg RSI</span>
                            <span class="metric-value">${data.avg_rsi.toFixed(1)}</span>
                        </div>
                    </div>
                </div>

                <div class="grid">
                    <div>
                        <h3 style="color: var(--accent-green); margin-bottom: 12px">Top Gainers</h3>
            `;

            for (const s of data.top_gainers.slice(0, 5)) {
                html += `
                    <div class="metric">
                        <span class="symbol" onclick="showQuote('${s.symbol}')">${s.symbol}</span>
                        <span class="metric-value positive">${formatPercent(s.daily_change)}</span>
                    </div>
                `;
            }

            html += `
                    </div>
                    <div>
                        <h3 style="color: var(--accent-red); margin-bottom: 12px">Top Losers</h3>
            `;

            for (const s of data.top_losers.slice(0, 5)) {
                html += `
                    <div class="metric">
                        <span class="symbol" onclick="showQuote('${s.symbol}')">${s.symbol}</span>
                        <span class="metric-value negative">${formatPercent(s.daily_change)}</span>
                    </div>
                `;
            }

            html += '</div></div>';

            // All stocks grid
            html += '<h3 style="margin: 24px 0 16px">All Stocks</h3><div class="stock-grid">';

            for (const s of data.all_stocks) {
                const changeClass = getColorClass(s.daily_change);
                html += `
                    <div class="stock-card" onclick="showQuote('${s.symbol}')">
                        <div class="stock-header">
                            <span class="stock-symbol">${s.symbol}</span>
                            <span class="stock-price">${formatCurrency(s.price)}</span>
                        </div>
                        <div class="stock-metrics">
                            <div class="stock-metric">
                                <div class="stock-metric-label">Day</div>
                                <div class="stock-metric-value ${changeClass}">${formatPercent(s.daily_change)}</div>
                            </div>
                            <div class="stock-metric">
                                <div class="stock-metric-label">RSI</div>
                                <div class="stock-metric-value">${s.rsi.toFixed(1)}</div>
                            </div>
                            <div class="stock-metric">
                                <div class="stock-metric-label">ATR</div>
                                <div class="stock-metric-value">${formatCurrency(s.atr)}</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            html += '</div>';
            container.innerHTML = html;
        }

        // Fetch and display screener results
        async function fetchScreener() {
            try {
                const res = await fetch('/api/screen');
                const data = await res.json();
                updateScreenerDisplay(data);
            } catch (err) {
                console.error('Failed to fetch screener:', err);
            }
        }

        // Chart instance
        let valueChart = null;

        // Fetch and display value history chart
        async function fetchValueHistory() {
            try {
                const res = await fetch('/api/value-history');
                const data = await res.json();
                updateValueChart(data);
            } catch (err) {
                console.error('Failed to fetch value history:', err);
            }
        }

        // Update value chart
        function updateValueChart(data) {
            const chartContainer = document.getElementById('chartContainer');
            const chartEmpty = document.getElementById('chartEmpty');
            const canvas = document.getElementById('valueChart');

            if (!data.history || data.history.length === 0) {
                chartContainer.style.display = 'none';
                chartEmpty.style.display = 'block';
                return;
            }

            chartContainer.style.display = 'block';
            chartEmpty.style.display = 'none';

            const labels = data.history.map(h => {
                const date = new Date(h.timestamp);
                return date.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            });

            const totalValues = data.history.map(h => h.total_value);
            const cashValues = data.history.map(h => h.cash);
            const holdingsValues = data.history.map(h => h.holdings_value);

            // Destroy existing chart if any
            if (valueChart) {
                valueChart.destroy();
            }

            const ctx = canvas.getContext('2d');
            valueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Total Value',
                            data: totalValues,
                            borderColor: '#58a6ff',
                            backgroundColor: 'rgba(88, 166, 255, 0.1)',
                            fill: true,
                            tension: 0.3,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        },
                        {
                            label: 'Cash',
                            data: cashValues,
                            borderColor: '#3fb950',
                            backgroundColor: 'transparent',
                            borderDash: [5, 5],
                            tension: 0.3,
                            pointRadius: 2
                        },
                        {
                            label: 'Holdings',
                            data: holdingsValues,
                            borderColor: '#d29922',
                            backgroundColor: 'transparent',
                            borderDash: [5, 5],
                            tension: 0.3,
                            pointRadius: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#e6edf3',
                                font: { size: 12 }
                            }
                        },
                        tooltip: {
                            backgroundColor: '#21262d',
                            titleColor: '#e6edf3',
                            bodyColor: '#e6edf3',
                            borderColor: '#30363d',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#8b949e', maxRotation: 45 },
                            grid: { color: '#21262d' }
                        },
                        y: {
                            ticks: {
                                color: '#8b949e',
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            },
                            grid: { color: '#21262d' },
                            suggestedMin: data.starting_cash * 0.9,
                            suggestedMax: Math.max(...totalValues) * 1.05
                        }
                    }
                }
            });

            // Add starting cash reference line annotation
            const startingCash = data.starting_cash;
            valueChart.options.plugins.annotation = {
                annotations: {
                    line1: {
                        type: 'line',
                        yMin: startingCash,
                        yMax: startingCash,
                        borderColor: '#f85149',
                        borderWidth: 1,
                        borderDash: [10, 5],
                        label: {
                            content: 'Starting Cash',
                            enabled: true,
                            color: '#f85149'
                        }
                    }
                }
            };
        }

        // Update screener display
        function updateScreenerDisplay(data) {
            const container = document.getElementById('screenerResults');

            if (!data.stocks || data.stocks.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No stocks currently pass screening criteria.</p></div>';
                return;
            }

            let html = `<p style="margin-bottom: 16px; color: var(--text-secondary)">Found ${data.count} stocks passing filters</p>`;
            html += `
                <table>
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th>Price</th>
                            <th>Daily</th>
                            <th>RSI</th>
                            <th>ATR</th>
                            <th>Max Buy</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            for (const s of data.stocks) {
                const changeClass = getColorClass(s.daily_change);
                html += `
                    <tr>
                        <td><span class="symbol" onclick="showQuote('${s.symbol}')">${s.symbol}</span></td>
                        <td>${formatCurrency(s.price)}</td>
                        <td class="${changeClass}">${formatPercent(s.daily_change)}</td>
                        <td>${s.rsi.toFixed(1)}</td>
                        <td>${formatCurrency(s.atr)}</td>
                        <td>${s.max_shares}</td>
                        <td>
                            ${s.max_shares > 0 ? `<button class="btn-buy" style="padding: 4px 12px; font-size: 0.8rem"
                                    onclick="quickBuy('${s.symbol}', ${s.max_shares})">Buy Max</button>` : ''}
                        </td>
                    </tr>
                `;
            }

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Show quote modal
        async function showQuote(symbol) {
            const modal = document.getElementById('quoteModal');
            const content = document.getElementById('quoteContent');

            document.getElementById('quoteSymbol').textContent = symbol;
            content.innerHTML = '<div class="loading"><div class="spinner"></div>Loading...</div>';
            modal.style.display = 'flex';

            try {
                const res = await fetch(`/api/quote/${symbol}`);
                const data = await res.json();

                if (data.error) {
                    content.innerHTML = `<p>${data.error}</p>`;
                    return;
                }

                const changeClass = getColorClass(data.daily_change);
                content.innerHTML = `
                    <div style="font-size: 2rem; font-weight: 700; margin-bottom: 16px">${formatCurrency(data.price)}</div>

                    <div class="metric">
                        <span class="metric-label">Daily Change</span>
                        <span class="metric-value ${changeClass}">${formatPercent(data.daily_change)}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Weekly Change</span>
                        <span class="metric-value ${getColorClass(data.weekly_change)}">${formatPercent(data.weekly_change)}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Monthly Change</span>
                        <span class="metric-value ${getColorClass(data.monthly_change)}">${formatPercent(data.monthly_change)}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">RSI</span>
                        <span class="metric-value">${data.rsi.toFixed(1)} ${data.rsi < 30 ? '(Oversold)' : data.rsi > 70 ? '(Overbought)' : ''}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">ATR</span>
                        <span class="metric-value">${formatCurrency(data.atr)}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">SMA 10 / 20 / 50</span>
                        <span class="metric-value">${formatCurrency(data.sma_10)} / ${formatCurrency(data.sma_20)} / ${formatCurrency(data.sma_50)}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Avg Volume</span>
                        <span class="metric-value">${data.avg_volume.toLocaleString()}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Max Buyable Shares</span>
                        <span class="metric-value">${data.max_shares}</span>
                    </div>

                    <div class="actions">
                        ${data.max_shares > 0 ? `<button class="btn-buy" onclick="quickBuy('${symbol}', 1); closeModal()">Buy 1</button>` : ''}
                        ${data.max_shares > 0 ? `<button class="btn-buy" onclick="quickBuy('${symbol}', ${data.max_shares}); closeModal()">Buy Max (${data.max_shares})</button>` : ''}
                    </div>
                `;
            } catch (err) {
                content.innerHTML = '<p>Failed to load quote data.</p>';
            }
        }

        // Close modal
        function closeModal() {
            document.getElementById('quoteModal').style.display = 'none';
        }

        // Quick buy
        function quickBuy(symbol, shares) {
            document.getElementById('tradeAction').value = 'BUY';
            document.getElementById('tradeSymbol').value = symbol;
            document.getElementById('tradeShares').value = shares;
            updateTradeButton();
            document.getElementById('tradeForm').dispatchEvent(new Event('submit'));
        }

        // Quick sell
        function quickSell(symbol, shares) {
            document.getElementById('tradeAction').value = 'SELL';
            document.getElementById('tradeSymbol').value = symbol;
            document.getElementById('tradeShares').value = shares;
            updateTradeButton();
            document.getElementById('tradeForm').dispatchEvent(new Event('submit'));
        }

        // Update trade button appearance
        function updateTradeButton() {
            const action = document.getElementById('tradeAction').value;
            const btn = document.getElementById('tradeBtn');
            btn.textContent = action;
            btn.className = action === 'BUY' ? 'btn-buy' : 'btn-sell';
        }

        // Execute trade
        async function executeTrade(action, symbol, shares) {
            const resultDiv = document.getElementById('tradeResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'trade-result';
            resultDiv.textContent = 'Processing...';

            try {
                const res = await fetch('/api/trade', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action, symbol, shares })
                });

                const data = await res.json();

                resultDiv.className = 'trade-result ' + (data.success ? 'success' : 'error');
                resultDiv.textContent = data.message;

                if (data.success) {
                    await fetchStatus();
                    await fetchHistory();
                }

                // Hide result after 5 seconds
                setTimeout(() => {
                    resultDiv.style.display = 'none';
                }, 5000);
            } catch (err) {
                resultDiv.className = 'trade-result error';
                resultDiv.textContent = 'Failed to execute trade';
            }
        }

        // Load stock universe for autocomplete
        async function loadConfig() {
            try {
                const res = await fetch('/api/config');
                const data = await res.json();
                stockUniverse = data.stock_universe;

                const datalist = document.getElementById('symbolList');
                datalist.innerHTML = stockUniverse.map(s => `<option value="${s}">`).join('');
            } catch (err) {
                console.error('Failed to load config:', err);
            }
        }

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                tab.classList.add('active');
                const tabId = tab.dataset.tab;
                document.getElementById(tabId).classList.add('active');

                // Lazy load tab content
                if (tabId === 'history') fetchHistory();
                if (tabId === 'chart') fetchValueHistory();
                if (tabId === 'market') fetchMarket();
                if (tabId === 'screener') fetchScreener();
            });
        });

        // Trade form
        document.getElementById('tradeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const action = document.getElementById('tradeAction').value;
            const symbol = document.getElementById('tradeSymbol').value.toUpperCase();
            const shares = parseFloat(document.getElementById('tradeShares').value);

            await executeTrade(action, symbol, shares);
        });

        // Update button on action change
        document.getElementById('tradeAction').addEventListener('change', updateTradeButton);

        // Close modal on overlay click
        document.getElementById('quoteModal').addEventListener('click', (e) => {
            if (e.target.id === 'quoteModal') closeModal();
        });

        // Close modal on Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });

        // Initial load
        loadConfig();
        fetchStatus();
        updateMarketStatus();

        // Auto-refresh every 60 seconds
        setInterval(fetchStatus, 60000);

        // Update market status every minute
        setInterval(updateMarketStatus, 60000);
    </script>
</body>
</html>
